[Unit]
Description=Kube API Server
After=network-online.target
 
[Service]
Type=simple

#sudo -u etcd {{etcd_install_folder}}/bin/etcdctl --cacert="{{etcd_install_folder}}/certs/ca.pem" --cert="{{etcd_install_folder}}/certs/{{inventory_hostname}}.pem" --key="{{etcd_install_folder}}/certs/{{inventory_hostname}}-key.pem" put $key bar

# maybe add webhook autorization-mode?
ExecStart={{kube_install}}/kube-apiserver --advertise-address={{ip_for_host[inventory_hostname]}} \
          --alsologtostderr --authorization-mode=RBAC,Node \
          --bind-address=0.0.0.0 \
          --client-ca-file="{{etcd_install_folder}}/certs/etcd-ca.pem" \
          --enable-bootstrap-token-auth=true \
          --encryption-provider-config="{{kube_conf}}/encryption-provider-config.yml"
          --etcd-cafile="{{etcd_install_folder}}/certs/etcd-ca.pem" \
          --etcd-certfile="{{etcd_install_folder}}/certs/{{inventory_hostname}}.pem" --etcd-keyfile="{{etcd_install_folder}}/certs/{{inventory_hostname}}-key.pem" \
          --etcd-servers="{% for host in workers_in_inventory %}{{host}}=https://{{ip_for_host[host]}}:2380,{% endfor %}" \
          --external-hostname="{{inventory_hostname}}" 




--name {{inventory_hostname}} --initial-advertise-peer-urls https://{{ip_for_host[inventory_hostname]}}:2380 \
  --listen-peer-urls https://{{ip_for_host[inventory_hostname]}}:2380 \
  --listen-client-urls https://{{ip_for_host[inventory_hostname]}}:2379,https://127.0.0.1:2379 \
  --advertise-client-urls https://{{ip_for_host[inventory_hostname]}}:2379,https://127.0.0.1:2379 \
  --initial-cluster-token etcd-cluster-1 \
  --initial-cluster {% for host in workers_in_inventory %}{{host}}=https://{{ip_for_host[host]}}:2380,{% endfor %} \
  --initial-cluster-state new \
  --client-cert-auth --trusted-ca-file="{{etcd_install_folder}}/certs/ca.pem" \
  --cert-file="{{etcd_install_folder}}/certs/{{inventory_hostname}}.pem" --key-file="{{etcd_install_folder}}/certs/{{inventory_hostname}}-key.pem" \
  --peer-client-cert-auth --peer-trusted-ca-file="{{etcd_install_folder}}/certs/ca.pem" \
  --peer-cert-file="{{etcd_install_folder}}/certs/{{inventory_hostname}}.pem" --peer-key-file="{{etcd_install_folder}}/certs/{{inventory_hostname}}-key.pem"
 
Restart=on-failure
 
# Configures the time to wait before service is stopped forcefully.
TimeoutStopSec=300
 
[Install]
WantedBy=multi-user.target